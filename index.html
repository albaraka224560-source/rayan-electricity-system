<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام ادارة فواتير كهرباء الريان</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- إصدار متوافق مع الوحدات -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDtVgNG_JgLz4L274CKBcW8ux9MKcknUYE",
            authDomain: "rayan-electricity-d26d4.firebaseapp.com",
            projectId: "rayan-electricity-d26d4",
            storageBucket: "rayan-electricity-d26d4.firebasestorage.app",
            messagingSenderId: "116488482995",
            appId: "1:116488482995:web:b7fa29dbda388f079c40c6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // جعل المتغيرات متاحة globally
        window.firebaseApp = app;
        window.firestore = db;
        window.firebaseAuth = auth;
        window.firebaseModules = {
            collection, doc, setDoc, getDoc, serverTimestamp,
            signInWithEmailAndPassword, onAuthStateChanged
        };

        console.log('تم تهيئة Firebase بنجاح!');
    </script>

    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 12px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 10px 10px;
            margin-bottom: 30px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .logo-img {
            height: 50px;
            width: auto;
        }
        
        .logo i {
            font-size: 2rem;
        }
        
        .logo h1 {
            font-size: 1.4rem;
            white-space: nowrap;
        }

        /* تحسين القائمة العلوية */
        nav ul {
            display: flex;
            list-style: none;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin: 0;
            padding: 0;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 5px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        nav a:hover, nav a.active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        nav i {
            font-size: 1rem;
        }

        /* تحسين القائمة الجانبية */
        .sidebar ul {
            list-style: none;
        }
        
        .sidebar li {
            margin-bottom: 15px;
        }
        
        .sidebar a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: var(--dark);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .sidebar a:hover, .sidebar a.active {
            background: var(--secondary);
            color: white;
            transform: translateX(-5px);
        }
        
        .sidebar i {
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        /* شريط حالة الاتصال */
        .connection-bar {
            background: #f39c12;
            color: white;
            padding: 10px 0;
            text-align: center;
            position: relative;
        }
        
        .connection-bar.online {
            background: #27ae60;
        }
        
        .connection-bar.offline {
            background: #e74c3c;
        }
        
        .sync-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .sync-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* أنماط تسجيل الدخول */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo {
            height: 80px;
            margin-bottom: 15px;
        }
        
        .login-header i {
            font-size: 3rem;
            color: var(--secondary);
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--secondary);
            outline: none;
        }
        
        input[readonly] {
            background-color: #f5f5f5;
            color: #666;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 25px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-info {
            background: #17a2b8;
        }
        
        .hidden {
            display: none;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* باقي الأنماط الأساسية */
        .main-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
        }
        
        .sidebar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .content {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .card-title {
            font-size: 1.2rem;
            color: var(--primary);
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: var(--light);
            color: var(--primary);
            font-weight: 600;
        }
        
        tr:hover {
            background: #f9f9f9;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            font-size: 1rem;
        }
        
        .stat-1 { background: var(--secondary); }
        .stat-2 { background: var(--success); }
        .stat-3 { background: var(--warning); }
        .stat-4 { background: var(--danger); }
        
        /* أنماط الجداول المحاسبية */
        .accounting-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .accounting-table th, .accounting-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        
        .accounting-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        
        .accounting-table tfoot {
            font-weight: bold;
        }
        
        .accounting-table tfoot td {
            background-color: #f9f9f9;
        }
        
        .debit {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .credit {
            color: #27ae60;
            font-weight: bold;
        }
        
        .balance-positive {
            color: #27ae60;
            font-weight: bold;
        }
        
        .balance-negative {
            color: #e74c3c;
            font-weight: bold;
        }

        /* جداول الكشف الإجمالي */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .summary-table th {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .summary-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        
        .summary-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .summary-table tr:hover {
            background: #e9ecef;
        }
        
        .summary-total {
            background: var(--light) !important;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .summary-positive {
            color: var(--success);
            font-weight: bold;
        }
        
        .summary-negative {
            color: var(--danger);
            font-weight: bold;
        }

        /* معاينة الفاتورة */
        .invoice-preview {
            border: 1px solid #ddd;
            padding: 15mm;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            width: 148mm;
            min-height: 210mm;
            margin: 0 auto;
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }
        
        .invoice-logo {
            height: 60px;
            margin-bottom: 10px;
        }
        
        .invoice-details {
            margin-bottom: 20px;
        }
        
        .invoice-table {
            margin-bottom: 20px;
            width: 100%;
        }
        
        .invoice-table table {
            width: 100%;
            border: 1px solid #ddd;
        }
        
        .invoice-table th, .invoice-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        
        .invoice-total {
            text-align: left;
            margin-top: 20px;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .invoice-footer {
            margin-top: 30px;
            text-align: center;
            color: #777;
            font-size: 0.9rem;
        }

        /* أنماط النوافذ المنبثقة */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* تحسين عرض الإشعار */
        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .receipt-table th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: right;
            border: 1px solid #ddd;
        }

        .receipt-table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: right;
        }

        .receipt-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .invoice-preview, .invoice-preview * {
                visibility: visible;
            }
            .invoice-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 148mm;
                height: 210mm;
                padding: 15mm;
                box-shadow: none;
                border: none;
                margin: 0;
                page-break-after: always;
            }
            .no-print {
                display: none !important;
            }
        }
        
        /* تحسين التبويبات للشاشات الصغيرة */
        @media (max-width: 1024px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            nav ul {
                gap: 8px;
                justify-content: flex-start;
                width: 100%;
            }
            
            nav a {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            .logo h1 {
                font-size: 1.2rem;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            nav ul {
                gap: 5px;
            }
            
            nav a {
                padding: 5px 8px;
                font-size: 0.75rem;
            }
            
            nav a span {
                display: none;
            }
            
            nav a i {
                margin: 0;
            }
            
            .logo h1 {
                font-size: 1.1rem;
            }
            
            .invoice-preview {
                width: 100%;
                padding: 15px;
            }
            
            .logo-img {
                height: 40px;
            }
            
            .login-logo {
                height: 60px;
            }
        }
    </style>
</head>
<body>
    <!-- شريط حالة الاتصال -->
    <div id="connectionBar" class="connection-bar">
        <span id="connectionStatus">جاري التحقق من الاتصال...</span>
        <button id="syncButton" class="sync-btn" style="display: none;">
            <i class="fas fa-sync-alt"></i> مزامنة مع السحابة
        </button>
    </div>

    <!-- واجهة تسجيل الدخول -->
    <div id="loginPage" class="login-container">
        <div class="login-header">
            <img src="https://i.ibb.co/W1NRmKy/rayan-elect.png" alt="كهرباء الريان" class="login-logo">
            <h2>نظام ادارة فواتير كهرباء الريان</h2>
            <p>متاح من أي جهاز</p>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">اسم المستخدم أو البريد الإلكتروني</label>
                <input type="text" id="username" required>
            </div>
            
            <div class="form-group">
                <label for="password">كلمة المرور</label>
                <input type="password" id="password" required>
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
                </button>
            </div>
        </form>
        
        <div class="alert alert-danger hidden" id="loginError">
            اسم المستخدم أو كلمة المرور غير صحيحة!
        </div>
    </div>

    <!-- الواجهة الرئيسية -->
    <div id="mainApp" class="hidden">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <img src="https://i.ibb.co/W1NRmKy/rayan-elect.png" alt="كهرباء الريان" class="logo-img">
                        <h1>كهرباء الريان</h1>
                    </div>
                    <nav>
                        <ul>
                            <li><a href="#" class="active" data-tab="dashboard" title="لوحة التحكم">
                                <i class="fas fa-tachometer-alt"></i><span>التحكم</span>
                            </a></li>
                            <li><a href="#" data-tab="customers" title="العملاء">
                                <i class="fas fa-users"></i><span>العملاء</span>
                            </a></li>
                            <li><a href="#" data-tab="readings" title="القراءات">
                                <i class="fas fa-file-invoice"></i><span>القراءات</span>
                            </a></li>
                            <li><a href="#" data-tab="payments" title="المدفوعات">
                                <i class="fas fa-money-bill-wave"></i><span>المدفوعات</span>
                            </a></li>
                            <li><a href="#" data-tab="accountStatement" title="كشف حساب">
                                <i class="fas fa-file-contract"></i><span>كشف حساب</span>
                            </a></li>
                            <li><a href="#" data-tab="cashBoxes" title="الصناديق">
                                <i class="fas fa-cash-register"></i><span>الصناديق</span>
                            </a></li>
                            <li><a href="#" data-tab="settings" id="settingsTab" class="hidden" title="الإعدادات">
                                <i class="fas fa-cog"></i><span>الإعدادات</span>
                            </a></li>
                            <li><a href="#" id="logoutBtn" title="تسجيل الخروج">
                                <i class="fas fa-sign-out-alt"></i><span>خروج</span>
                            </a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </header>
        
        <div class="container">
            <div class="main-content">
                <aside class="sidebar">
                    <h3>القائمة الرئيسية</h3>
                    <ul>
                        <li><a href="#" class="active" data-tab="dashboard"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a></li>
                        <li><a href="#" data-tab="customers"><i class="fas fa-users"></i> إدارة العملاء</a></li>
                        <li><a href="#" data-tab="readings"><i class="fas fa-file-invoice"></i> تسجيل القراءات</a></li>
                        <li><a href="#" data-tab="payments"><i class="fas fa-money-bill-wave"></i> قبض المدفوعات</a></li>
                        <li><a href="#" data-tab="accountStatement"><i class="fas fa-file-contract"></i> كشف حساب</a></li>
                        <li><a href="#" data-tab="cashBoxes"><i class="fas fa-cash-register"></i> إدارة الصناديق</a></li>
                        <!-- إضافة خيار تغيير كلمة السر -->
                        <li><a href="#" data-tab="changePassword"><i class="fas fa-key"></i> تغيير كلمة السر</a></li>
                    </ul>
                </aside>
                
                <main class="content">
                    <!-- لوحة التحكم -->
                    <div id="dashboard" class="tab-content active">
                        <h2>لوحة التحكم</h2>
                        <p>مرحباً بك في نظام ادارة فواتير كهرباء الريان</p>
                        
                        <div class="grid-2" style="margin: 30px 0; gap: 20px;">
                            <div class="stat-card stat-1">
                                <i class="fas fa-users"></i>
                                <h3 id="totalCustomers">0</h3>
                                <p>إجمالي العملاء</p>
                            </div>
                            <div class="stat-card stat-2">
                                <i class="fas fa-file-invoice-dollar"></i>
                                <h3 id="totalInvoices">0</h3>
                                <p>إجمالي الفواتير</p>
                            </div>
                            <div class="stat-card stat-3">
                                <i class="fas fa-money-bill"></i>
                                <h3 id="totalPayments">0</h3>
                                <p>إجمالي المتحصلات</p>
                            </div>
                            <div class="stat-card stat-4">
                                <i class="fas fa-exclamation-circle"></i>
                                <h3 id="totalOverdue">0</h3>
                                <p>عملاء متأخرين</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- إدارة العملاء -->
                    <div id="customers" class="tab-content">
                        <h2>إدارة العملاء</h2>
                        <p>إضافة وتعديل وحذف بيانات العملاء</p>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">إضافة عميل جديد</h3>
                            </div>
                            <form id="customerForm">
                                <div class="grid-3">
                                    <div class="form-group">
                                        <label for="customerName">اسم العميل</label>
                                        <input type="text" id="customerName" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="customerCity">المدينة</label>
                                        <input type="text" id="customerCity" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="customerPhone">رقم الهاتف</label>
                                        <input type="tel" id="customerPhone" placeholder="7xxxxxxxx" pattern="[0-9]{9}" required>
                                        <small style="color: #666;">يجب أن يتكون من 9 أرقام ويبدأ بـ 7</small>
                                    </div>
                                </div>
                                <div class="grid-2">
                                    <div class="form-group">
                                        <label for="customerAddress">العنوان</label>
                                        <textarea id="customerAddress" rows="2"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="registrationDate">تاريخ التسجيل</label>
                                        <input type="date" id="registrationDate" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success">إضافة العميل</button>
                            </form>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">قائمة العملاء</h3>
                                <div>
                                    <input type="text" id="customerSearch" placeholder="بحث عن عميل..." style="width: 250px; padding: 8px;">
                                </div>
                            </div>
                            <table id="customersTable">
                                <thead>
                                    <tr>
                                        <th>كود العميل</th>
                                        <th>اسم العميل</th>
                                        <th>المدينة</th>
                                        <th>رقم الهاتف</th>
                                        <th>تاريخ التسجيل</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- سيتم ملؤها بالبيانات -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- تسجيل القراءات -->
                    <div id="readings" class="tab-content">
                        <h2>تسجيل القراءات وإصدار الفواتير</h2>
                        <p>تسجيل قراءات العداد وإصدار فواتير الكهرباء</p>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">بيانات الفاتورة</h3>
                            </div>
                            <form id="readingForm">
                                <div class="grid-2">
                                    <div class="form-group">
                                        <label for="customerSelect">اختر العميل</label>
                                        <select id="customerSelect" required>
                                            <option value="">-- اختر العميل --</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="invoiceMonth">الشهر المستحق</label>
                                        <select id="invoiceMonth" required>
                                            <option value="">-- اختر الشهر --</option>
                                            <option value="01">يناير</option>
                                            <option value="02">فبراير</option>
                                            <option value="03">مارس</option>
                                            <option value="04">أبريل</option>
                                            <option value="05">مايو</option>
                                            <option value="06">يونيو</option>
                                            <option value="07">يوليو</option>
                                            <option value="08">أغسطس</option>
                                            <option value="09">سبتمبر</option>
                                            <option value="10">أكتوبر</option>
                                            <option value="11">نوفمبر</option>
                                            <option value="12">ديسمبر</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid-3">
                                    <div class="form-group">
                                        <label for="previousReading">القراءة السابقة</label>
                                        <input type="number" id="previousReading" required readonly>
                                        <small style="color: #666;">يتم تعبئته تلقائياً بناءً على آخر قراءة</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="currentReading">القراءة الحالية</label>
                                        <input type="number" id="currentReading" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="consumption">فارق القراءات (ك.و.س)</label>
                                        <input type="number" id="consumption" readonly>
                                    </div>
                                </div>
                                
                                <div class="grid-3">
                                    <div class="form-group">
                                        <label for="rate">سعر الكيلو وات (ريال يمني)</label>
                                        <input type="number" id="rate" step="0.01" readonly>
                                        <small style="color: #666;">يتم تعيينه من الإعدادات</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="arrears">المتأخرات (ريال يمني)</label>
                                        <input type="number" id="arrears" step="0.01" value="0" readonly>
                                        <small style="color: #666;">يتم حسابها تلقائياً بناءً على رصيد العميل</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="totalAmount">إجمالي المبلغ (ريال يمني)</label>
                                        <input type="number" id="totalAmount" step="0.01" readonly>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <button type="button" id="calculateBtn" class="btn btn-warning">حساب الفاتورة</button>
                                    <button type="submit" class="btn btn-success">ترحيل الفاتورة</button>
                                    <button type="button" id="printInvoiceBtn" class="btn no-print" style="display: none;">طباعة الفاتورة</button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="invoice-preview no-print" id="invoicePreview" style="display: none;">
                            <div class="invoice-header">
                                <div>
                                    <img src="https://i.ibb.co/W1NRmKy/rayan-elect.png" alt="كهرباء الريان" class="invoice-logo">
                                    <h2>فاتورة كهرباء</h2>
                                    <p>رقم الفاتورة: <span id="previewInvoiceNo">INV-2023-0001</span></p>
                                </div>
                                <div>
                                    <p>كهرباء الريان</p>
                                    <p>صنعاء - الجمهورية اليمنية</p>
                                    <p>هاتف: 01456789</p>
                                </div>
                            </div>
                            
                            <div class="invoice-details grid-2">
                                <div>
                                    <p><strong>العميل:</strong> <span id="previewCustomerName">-</span></p>
                                    <p><strong>كود العميل:</strong> <span id="previewCustomerCode">-</span></p>
                                    <p><strong>العنوان:</strong> <span id="previewCustomerAddress">-</span></p>
                                </div>
                                <div>
                                    <p><strong>تاريخ الإصدار:</strong> <span id="previewIssueDate">-</span></p>
                                    <p><strong>الشهر المستحق:</strong> <span id="previewMonth">-</span></p>
                                    <p><strong>موعد السداد:</strong> <span id="previewDueDate">-</span></p>
                                </div>
                            </div>
                            
                            <div class="invoice-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>القراءة السابقة</th>
                                            <th>القراءة الحالية</th>
                                            <th>فارق الاستهلاك (ك.و.س)</th>
                                            <th>سعر الكيلو وات</th>
                                            <th>المتأخرات</th>
                                            <th>الإجمالي المستحق</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td id="previewPreviousReading">-</td>
                                            <td id="previewCurrentReading">-</td>
                                            <td id="previewConsumption">-</td>
                                            <td id="previewRate">-</td>
                                            <td id="previewArrears">-</td>
                                            <td id="previewTotal">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="invoice-footer">
                                <p>شكراً لاستخدامكم خدماتنا</p>
                                <p>للاستفسار يرجى الاتصال على: 01456789</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- قبض المدفوعات -->
                    <div id="payments" class="tab-content">
                        <h2>قبض المدفوعات</h2>
                        <p>تسجيل مدفوعات العملاء وإصدار إشعارات التسديد</p>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">تسديد مبلغ</h3>
                            </div>
                            <form id="paymentForm">
                                <div class="grid-2">
                                    <div class="form-group">
                                        <label for="paymentCustomerSelect">اختر العميل</label>
                                        <select id="paymentCustomerSelect" required>
                                            <option value="">-- اختر العميل --</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="paymentAmount">المبلغ (ريال يمني)</label>
                                        <input type="number" id="paymentAmount" step="0.01" required>
                                    </div>
                                </div>
                                
                                <div class="grid-2">
                                    <div class="form-group">
                                        <label for="paymentDate">تاريخ السداد</label>
                                        <input type="date" id="paymentDate" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="paymentMethod">طريقة الدفع</label>
                                        <select id="paymentMethod" required>
                                            <option value="cash">نقدي</option>
                                            <option value="card">بطاقة ائتمان</option>
                                            <option value="transfer">تحويل بنكي</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="cashBoxDisplay">الصندوق</label>
                                    <input type="text" id="cashBoxDisplay" readonly>
                                    <input type="hidden" id="cashBoxId" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="paymentNotes">ملاحظات</label>
                                    <input type="text" id="paymentNotes">
                                </div>
                                
                                <div class="form-group">
                                    <button type="submit" class="btn btn-success">تسجيل الدفع</button>
                                    <button type="button" id="printReceiptBtn" class="btn no-print" style="display: none;">طباعة إشعار التسديد</button>
                                </div>
                            </form>
                        </div>

                        <!-- معاينة إشعار التسديد -->
                        <div class="invoice-preview no-print" id="receiptPreview" style="display: none;">
                            <div class="invoice-header">
                                <div>
                                    <img src="https://i.ibb.co/W1NRmKy/rayan-elect.png" alt="كهرباء الريان" class="invoice-logo">
                                    <h2>إشعار تسديد</h2>
                                    <p>رقم الإشعار: <span id="previewReceiptNo">RC-2023-0001</span></p>
                                </div>
                                <div>
                                    <p>كهرباء الريان</p>
                                    <p>صنعاء - الجمهورية اليمنية</p>
                                    <p>هاتف: 01456789</p>
                                </div>
                            </div>
                            
                            <div class="invoice-details grid-2">
                                <div>
                                    <p><strong>العميل:</strong> <span id="previewReceiptCustomerName">-</span></p>
                                    <p><strong>كود العميل:</strong> <span id="previewReceiptCustomerCode">-</span></p>
                                </div>
                                <div>
                                    <p><strong>تاريخ السداد:</strong> <span id="previewReceiptDate">-</span></p>
                                    <p><strong>طريقة الدفع:</strong> <span id="previewPaymentMethod">-</span></p>
                                </div>
                            </div>
                            
                            <div class="invoice-table">
                                <table class="receipt-table">
                                    <thead>
                                        <tr>
                                            <th>البند</th>
                                            <th>القيمة</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>المبلغ المدفوع</strong></td>
                                            <td id="previewPaymentAmount">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>الصندوق</strong></td>
                                            <td id="previewCashBoxName">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>رقم العملية</strong></td>
                                            <td id="previewPaymentNumber">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ملاحظات</strong></td>
                                            <td id="previewPaymentNotes">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="invoice-total">
                                <p>المبلغ المستلم: <span id="previewTotalAmount">-</span> ريال يمني</p>
                            </div>
                            
                            <div class="invoice-footer">
                                <p>شكراً لسدادكم الفاتورة في موعدها</p>
                                <p>للاستفسار يرجى الاتصال على: 01456789</p>
                                <p>توقيع المسؤول: ________________</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- كشف حساب العميل -->
                    <div id="accountStatement" class="tab-content">
                        <h2>كشف حساب</h2>
                        <p>استعراض كشف حساب العميل أو الصندوق بشكل إجمالي أو تفصيلي خلال فترة محددة</p>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">معايير البحث</h3>
                            </div>
                            <form id="statementForm">
                                <div class="grid-3">
                                    <div class="form-group">
                                        <label for="statementAccountSelect">اختر الحساب</label>
                                        <select id="statementAccountSelect" required>
                                            <option value="">-- اختر الحساب --</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="statementDetailType">نوع الكشف</label>
                                        <select id="statementDetailType" required>
                                            <option value="detailed">كشف تفصيلي</option>
                                            <option value="summary">كشف إجمالي</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="fromDate">من تاريخ</label>
                                        <input type="date" id="fromDate" required>
                                    </div>
                                </div>
                                
                                <div class="grid-3">
                                    <div class="form-group">
                                        <label for="toDate">إلى تاريخ</label>
                                        <input type="date" id="toDate" required>
                                    </div>
                                    <div class="form-group">
                                        <label style="visibility: hidden;">زر الاستعراض</label>
                                        <button type="submit" class="btn" style="width: 100%;">استعراض الكشف</button>
                                    </div>
                                    <div class="form-group">
                                        <label style="visibility: hidden;">زر الطباعة</label>
                                        <button type="button" id="printStatementBtn" class="btn no-print" style="width: 100%;">طباعة الكشف</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <div class="card" id="statementResult" style="display: none;">
                            <div class="card-header">
                                <h3 class="card-title">نتيجة الكشف</h3>
                            </div>
                            <div id="statementContent">
                                <!-- سيتم ملؤها بالبيانات -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- إدارة الصناديق -->
                    <div id="cashBoxes" class="tab-content">
                        <h2>إدارة الصناديق</h2>
                        <p>إضافة وتعديل وحذف الصناديق وربطها بالمستخدمين</p>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">إضافة صندوق جديد</h3>
                            </div>
                            <form id="cashBoxForm">
                                <div class="grid-2">
                                    <div class="form-group">
                                        <label for="cashBoxName">اسم الصندوق</label>
                                        <input type="text" id="cashBoxName" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="cashBoxUser">المستخدم المسؤول</label>
                                        <select id="cashBoxUser" required>
                                            <option value="">-- اختر المستخدم --</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid-2">
                                    <div class="form-group">
                                        <label for="initialBalance">الرصيد الافتتاحي (ريال يمني)</label>
                                        <input type="number" id="initialBalance" step="0.01" value="0" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="cashBoxStatus">حالة الصندوق</label>
                                        <select id="cashBoxStatus" required>
                                            <option value="active">نشط</option>
                                            <option value="inactive">غير نشط</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <button type="submit" class="btn btn-success">إضافة الصندوق</button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">قائمة الصناديق</h3>
                            </div>
                            <table id="cashBoxesTable">
                                <thead>
                                    <tr>
                                        <th>اسم الصندوق</th>
                                        <th>المسؤول</th>
                                        <th>الرصيد الحالي</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- سيتم ملؤها بالبيانات -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- الإعدادات -->
                    <div id="settings" class="tab-content">
                        <h2>الإعدادات العامة</h2>
                        <p>إعدادات النظام العامة</p>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">إعدادات الكهرباء</h3>
                            </div>
                            <form id="settingsForm">
                                <div class="grid-2">
                                    <div class="form-group">
                                        <label for="electricityRate">سعر الكيلو وات (ريال يمني)</label>
                                        <input type="number" id="electricityRate" step="0.01" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="dueDays">عدد أيام السماح (للتأخير)</label>
                                        <input type="number" id="dueDays" value="15" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <button type="submit" class="btn btn-success">حفظ الإعدادات</button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">الإعدادات الحالية</h3>
                            </div>
                            <table>
                                <tbody>
                                    <tr>
                                        <th>سعر الكيلو وات</th>
                                        <td id="currentRate">-</td>
                                    </tr>
                                    <tr>
                                        <th>أيام السماح</th>
                                        <td id="currentDueDays">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- قسم إدارة المستخدمين -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">إدارة المستخدمين</h3>
                            </div>
                            <form id="userForm">
                                <div class="grid-2">
                                    <div class="form-group">
                                        <label for="userFullName">الاسم الكامل</label>
                                        <input type="text" id="userFullName" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="userUsername">اسم المستخدم</label>
                                        <input type="text" id="userUsername" required>
                                    </div>
                                </div>
                                
                                <div class="grid-2">
                                    <div class="form-group">
                                        <label for="userRole">نوع المستخدم</label>
                                        <select id="userRole" required>
                                            <option value="user">مستخدم عادي</option>
                                            <option value="admin">مدير النظام</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="userInitialPassword">كلمة المرور الابتدائية</label>
                                        <input type="password" id="userInitialPassword" required>
                                        <small style="color: #666;">سيتم طلب تغييرها عند أول دخول</small>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <button type="submit" class="btn btn-success">إضافة المستخدم</button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">قائمة المستخدمين</h3>
                            </div>
                            <table id="usersTable">
                                <thead>
                                    <tr>
                                        <th>الاسم الكامل</th>
                                        <th>اسم المستخدم</th>
                                        <th>نوع المستخدم</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- سيتم ملؤها بالبيانات -->
                                </tbody>
                            </table>
                        </div>

                        <!-- قسم تصفير قاعدة البيانات -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">تصفير قاعدة البيانات</h3>
                            </div>
                            <div class="card-body">
                                <p class="text-danger"><strong>تحذير:</strong> هذه العملية ستحذف جميع العملاء والفواتير والمقبوضات وحركات الصناديق. لا يمكن التراجع عن هذه العملية!</p>
                                <p>سيتم الاحتفاظ بالمستخدمين والصناديق والإعدادات فقط.</p>
                                <div class="form-group">
                                    <button type="button" id="resetDataBtn" class="btn btn-danger">
                                        <i class="fas fa-database"></i> تصفير قاعدة البيانات
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- تبويب تغيير كلمة السر -->
                    <div id="changePassword" class="tab-content">
                        <h2>تغيير كلمة السر</h2>
                        <p>تغيير كلمة المرور الخاصة بحسابك</p>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">تغيير كلمة المرور</h3>
                            </div>
                            <form id="changePasswordTabForm">
                                <div class="form-group">
                                    <label for="currentPasswordTab">كلمة المرور الحالية</label>
                                    <input type="password" id="currentPasswordTab" required>
                                </div>
                                <div class="form-group">
                                    <label for="newPasswordTab">كلمة المرور الجديدة</label>
                                    <input type="password" id="newPasswordTab" required minlength="6">
                                    <small style="color: #666;">يجب أن تكون كلمة المرور الجديدة 6 أحرف على الأقل</small>
                                </div>
                                <div class="form-group">
                                    <label for="confirmPasswordTab">تأكيد كلمة المرور الجديدة</label>
                                    <input type="password" id="confirmPasswordTab" required>
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-success">تغيير كلمة المرور</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- نافذة تغيير كلمة المرور -->
    <div id="changePasswordModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">تغيير كلمة المرور</h3>
                </div>
                <div class="card-body">
                    <p>يجب تغيير كلمة المرور لأول مرة استخدام النظام</p>
                    <form id="changePasswordForm">
                        <div class="form-group">
                            <label for="currentPassword">كلمة المرور الحالية</label>
                            <input type="password" id="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">كلمة المرور الجديدة</label>
                            <input type="password" id="newPassword" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">تأكيد كلمة المرور الجديدة</label>
                            <input type="password" id="confirmPassword" required>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-success">تغيير كلمة المرور</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // بيانات النظام
        let customers = [];
        let invoices = [];
        let payments = [];
        let users = [];
        let cashBoxes = [];
        let cashBoxMovements = [];
        let settings = {};
        let currentUser = null;
        let isOnline = navigator.onLine;
        let lastGeneratedInvoice = null;
        let lastGeneratedPayment = null;

        // التحقق من اكتمال تحميل Firebase
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.firestore && window.firebaseAuth) {
                        resolve();
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        // التحقق من الاتصال بالإنترنت
        function updateConnectionStatus() {
            const connectionBar = document.getElementById('connectionBar');
            const statusText = document.getElementById('connectionStatus');
            const syncButton = document.getElementById('syncButton');
            
            isOnline = navigator.onLine;
            
            if (isOnline) {
                connectionBar.className = 'connection-bar online';
                statusText.innerHTML = '<i class="fas fa-wifi"></i> متصل بالإنترنت - النظام نشط';
                syncButton.style.display = 'inline-block';
            } else {
                connectionBar.className = 'connection-bar offline';
                statusText.innerHTML = '<i class="fas fa-wifi-slash"></i> غير متصل - العمل في الوضع المحلي';
                syncButton.style.display = 'none';
            }
        }

        // دالة لحساب رصيد العميل (المتأخرات)
        function calculateCustomerBalance(customerCode) {
            let totalInvoices = 0;
            let totalPayments = 0;
            
            // جمع إجمالي فواتير العميل
            const customerInvoices = invoices.filter(inv => inv.customerCode === customerCode);
            customerInvoices.forEach(invoice => {
                totalInvoices += parseFloat(invoice.totalAmount);
            });
            
            // جمع إجمالي مدفوعات العميل
            const customerPayments = payments.filter(pay => pay.customerCode === customerCode);
            customerPayments.forEach(payment => {
                totalPayments += parseFloat(payment.amount);
            });
            
            // الرصيد = إجمالي الفواتير - إجمالي المدفوعات
            const balance = totalInvoices - totalPayments;
            
            // إذا كان الرصيد موجب (عليه دين) نرجعه، وإلا نرجع صفر
            return balance > 0 ? balance : 0;
        }

        // التخزين المحلي
        function saveToLocalStorage() {
            const data = {
                customers: customers,
                invoices: invoices,
                payments: payments,
                users: users,
                cashBoxes: cashBoxes,
                cashBoxMovements: cashBoxMovements,
                settings: settings,
                lastUpdate: new Date().toISOString()
            };
            
            localStorage.setItem('rayanElectricityData', JSON.stringify(data));
            console.log('تم الحفظ محلياً');
        }

        // التحميل من التخزين المحلي
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('rayanElectricityData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    customers = data.customers || [];
                    invoices = data.invoices || [];
                    payments = data.payments || [];
                    users = data.users || getDefaultUsers();
                    cashBoxes = data.cashBoxes || [];
                    cashBoxMovements = data.cashBoxMovements || [];
                    settings = data.settings || getDefaultSettings();
                    return true;
                }
            } catch (error) {
                console.error('خطأ في تحميل البيانات المحلية:', error);
            }
            return false;
        }

        // الحفظ في Firebase
        async function saveToFirebase() {
            if (!isOnline) {
                console.log('لا يوجد اتصال - تم الحفظ محلياً فقط');
                return false;
            }

            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) {
                    console.log('لا يوجد مستخدم مسجل الدخول');
                    return false;
                }

                const { doc, setDoc, serverTimestamp } = window.firebaseModules;
                const data = {
                    customers: customers,
                    invoices: invoices,
                    payments: payments,
                    users: users,
                    cashBoxes: cashBoxes,
                    cashBoxMovements: cashBoxMovements,
                    settings: settings,
                    lastUpdated: serverTimestamp(),
                    updatedBy: user.email
                };

                await setDoc(doc(window.firestore, 'companies', 'rayan_electricity'), data, { merge: true });
                console.log('تم الحفظ في السحابة بنجاح');
                return true;
            } catch (error) {
                console.error('خطأ في الحفظ السحابي:', error);
                return false;
            }
        }

        // التحميل من Firebase
        async function loadFromFirebase() {
            if (!isOnline) {
                console.log('لا يوجد اتصال - سيتم استخدام البيانات المحلية');
                return false;
            }

            try {
                const { doc, getDoc } = window.firebaseModules;
                const docRef = doc(window.firestore, 'companies', 'rayan_electricity');
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    customers = data.customers || [];
                    invoices = data.invoices || [];
                    payments = data.payments || [];
                    users = data.users || getDefaultUsers();
                    cashBoxes = data.cashBoxes || [];
                    cashBoxMovements = data.cashBoxMovements || [];
                    settings = data.settings || getDefaultSettings();
                    
                    saveToLocalStorage();
                    console.log('تم تحميل البيانات من السحابة');
                    return true;
                } else {
                    console.log('لا توجد بيانات في السحابة - سيتم استخدام البيانات المحلية');
                    return false;
                }
            } catch (error) {
                console.error('خطأ في التحميل السحابي:', error);
                return false;
            }
        }

        // الدالة الرئيسية للحفظ
        function saveData() {
            saveToLocalStorage();
            
            // محاولة الحفظ في السحابة إذا كان هناك اتصال
            if (isOnline) {
                saveToFirebase().catch(error => {
                    console.log('فشل الحفظ التلقائي في السحابة:', error);
                });
            }
            
            updateDashboard();
            populateCustomerSelects();
            populateCustomersTable();
            populateInvoicesTable();
            populateCashBoxesTable();
            populateCashBoxSelect();
            populateUsersTable();
            updateSettingsDisplay();
            updateUserInterface();
        }

        // المزامنة اليدوية
        async function manualSync() {
            if (!isOnline) {
                alert('لا يوجد اتصال بالإنترنت!');
                return;
            }

            try {
                const success = await saveToFirebase();
                if (success) {
                    alert('تم مزامنة البيانات مع السحابة بنجاح!');
                } else {
                    alert('فشلت المزامنة مع السحابة');
                }
            } catch (error) {
                alert('خطأ في المزامنة: ' + error.message);
            }
        }

        // البيانات الافتراضية
        function getDefaultUsers() {
            return [
                { 
                    username: 'admin', 
                    password: '123', 
                    fullName: 'مدير النظام', 
                    role: 'admin', 
                    created: new Date().toISOString(),
                    mustChangePassword: false, // admin لا يحتاج لتغيير كلمة المرور
                    isFirstLogin: false
                }
            ];
        }

        function getDefaultSettings() {
            return {
                electricityRate: 25,
                dueDays: 15
            };
        }

        // تحديث واجهة المستخدم بناءً على الصلاحيات
        function updateUserInterface() {
            const isAdmin = currentUser && currentUser.role === 'admin';
            
            // إظهار أو إخفاء قائمة الإعدادات
            const settingsTab = document.getElementById('settingsTab');
            
            if (isAdmin) {
                settingsTab.classList.remove('hidden');
            } else {
                settingsTab.classList.add('hidden');
            }
        }

        // الحصول على الصندوق المرتبط بالمستخدم الحالي
        function getCurrentUserCashBox() {
            if (!currentUser) return null;
            return cashBoxes.find(cb => cb.userId === currentUser.username && cb.status === 'active');
        }

        // تحديث عرض الصندوق في قسم المدفوعات
        function updateCashBoxDisplay() {
            const cashBox = getCurrentUserCashBox();
            const displayField = document.getElementById('cashBoxDisplay');
            const hiddenField = document.getElementById('cashBoxId');
            
            if (cashBox) {
                // التعديل: عرض اسم الصندوق فقط دون الرصيد
                displayField.value = cashBox.name;
                hiddenField.value = cashBox.id;
            } else {
                displayField.value = 'لا يوجد صندوق مرتبط بحسابك';
                hiddenField.value = '';
            }
        }

        // دالة عرض نافذة تغيير كلمة المرور
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'flex';
        }

        // دالة إخفاء نافذة تغيير كلمة المرور
        function hideChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
        }

        // تصفير قاعدة البيانات
        function resetDatabase() {
            if (confirm('هل أنت متأكد من تصفير قاعدة البيانات؟\n\nسيتم حذف جميع العملاء والفواتير والمقبوضات وحركات الصناديق.\nلا يمكن التراجع عن هذه العملية!')) {
                // حذف العملاء والفواتير والمقبوضات وحركات الصناديق
                customers = [];
                invoices = [];
                payments = [];
                cashBoxMovements = [];
                
                // إعادة تعيين أرصدة الصناديق إلى الرصيد الافتتاحي
                cashBoxes.forEach(cashBox => {
                    // البحث عن حركة الرصيد الافتتاحي
                    const openingBalanceMovement = cashBoxMovements.find(mov => 
                        mov.cashBoxId === cashBox.id && mov.description === 'رصيد افتتاحي'
                    );
                    
                    if (openingBalanceMovement) {
                        cashBox.balance = openingBalanceMovement.credit;
                    } else {
                        cashBox.balance = 0;
                    }
                });
                
                saveData();
                alert('تم تصفير قاعدة البيانات بنجاح!');
            }
        }

        // تسجيل الدخول
        async function loginUser(username, password) {
            try {
                // محاولة تسجيل الدخول المحلي أولاً
                const localUser = users.find(u => u.username === username && u.password === password);
                
                if (localUser) {
                    currentUser = localUser;
                    
                    // التحقق مما إذا كان يجب تغيير كلمة المرور (باستثناء admin)
                    if (currentUser.mustChangePassword && currentUser.username !== 'admin') {
                        showChangePasswordModal();
                    }
                    
                    return { success: true, type: 'local' };
                }

                // محاولة تسجيل الدخول السحابي
                if (isOnline) {
                    const { signInWithEmailAndPassword } = window.firebaseModules;
                    const firebaseEmail = username.includes('@') ? username : username + '@rayan.com';
                    const userCredential = await signInWithEmailAndPassword(window.firebaseAuth, firebaseEmail, password);
                    currentUser = userCredential.user;
                    
                    // تحميل البيانات من السحابة بعد تسجيل الدخول
                    await loadFromFirebase();
                    return { success: true, type: 'firebase' };
                }

                return { success: false, message: 'بيانات الدخول غير صحيحة' };
            } catch (error) {
                console.error('خطأ في تسجيل الدخول:', error);
                return { success: false, message: 'بيانات الدخول غير صحيحة' };
            }
        }

        // تحديث لوحة التحكم
        function updateDashboard() {
            document.getElementById('totalCustomers').textContent = customers.length;
            document.getElementById('totalInvoices').textContent = invoices.length;
            
            const totalPayments = payments.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);
            document.getElementById('totalPayments').textContent = totalPayments.toFixed(2);
            
            // حساب العملاء المتأخرين (لديهم فواتير غير مدفوعة)
            let overdueCount = 0;
            customers.forEach(customer => {
                const customerInvoices = invoices.filter(inv => inv.customerCode === customer.code && !inv.paid);
                if (customerInvoices.length > 0) {
                    overdueCount++;
                }
            });
            document.getElementById('totalOverdue').textContent = overdueCount;
        }

        // تحديث عرض الإعدادات
        function updateSettingsDisplay() {
            document.getElementById('currentRate').textContent = settings.electricityRate + ' ريال يمني';
            document.getElementById('currentDueDays').textContent = settings.dueDays + ' يوم';
            document.getElementById('electricityRate').value = settings.electricityRate;
            document.getElementById('dueDays').value = settings.dueDays;
        }

        // تعبئة قوائم العملاء
        function populateCustomerSelects() {
            const customerSelects = [
                document.getElementById('customerSelect'),
                document.getElementById('paymentCustomerSelect')
            ];
            
            customerSelects.forEach(select => {
                select.innerHTML = '<option value="">-- اختر العميل --</option>';
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.code;
                    option.textContent = `${customer.name} (${customer.code})`;
                    select.appendChild(option);
                });
            });
            
            // تحديث حقل السعر
            document.getElementById('rate').value = settings.electricityRate;
        }

        // تعبئة جدول العملاء
        function populateCustomersTable() {
            const tableBody = document.querySelector('#customersTable tbody');
            tableBody.innerHTML = '';
            
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.code}</td>
                    <td>${customer.name}</td>
                    <td>${customer.city}</td>
                    <td>+967 ${customer.phone}</td>
                    <td>${customer.registrationDate}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteCustomer('${customer.code}')">حذف</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // تعبئة جدول الفواتير
        function populateInvoicesTable() {
            // هذه الدالة سوف تستخدم في لوحة التحكم
        }

        // تعبئة قائمة الصناديق
        function populateCashBoxSelect() {
            const cashBoxSelect = document.getElementById('statementAccountSelect');
            cashBoxSelect.innerHTML = '<option value="">-- اختر الحساب --</option>';
            
            // إضافة العملاء
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = `customer_${customer.code}`;
                option.textContent = `${customer.name} (عميل)`;
                option.setAttribute('data-type', 'customer');
                cashBoxSelect.appendChild(option);
            });
            
            // إضافة الصناديق
            cashBoxes.forEach(cashBox => {
                const option = document.createElement('option');
                option.value = `cashbox_${cashBox.id}`;
                option.textContent = `${cashBox.name} (صندوق)`;
                option.setAttribute('data-type', 'cashbox');
                cashBoxSelect.appendChild(option);
            });
        }

        // تعبئة جدول الصناديق
        function populateCashBoxesTable() {
            const tableBody = document.querySelector('#cashBoxesTable tbody');
            tableBody.innerHTML = '';
            
            cashBoxes.forEach(cashBox => {
                const user = users.find(u => u.username === cashBox.userId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cashBox.name}</td>
                    <td>${user ? user.fullName : 'غير معروف'}</td>
                    <td>${cashBox.balance} ريال يمني</td>
                    <td>${cashBox.status === 'active' ? 'نشط' : 'غير نشط'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteCashBox('${cashBox.id}')">حذف</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // تعبئة قائمة المستخدمين في إدارة الصناديق
            const userSelect = document.getElementById('cashBoxUser');
            userSelect.innerHTML = '<option value="">-- اختر المستخدم --</option>';
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = `${user.fullName} (${user.username})`;
                userSelect.appendChild(option);
            });
        }

        // تعبئة جدول المستخدمين
        function populateUsersTable() {
            const tableBody = document.querySelector('#usersTable tbody');
            tableBody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.fullName}</td>
                    <td>${user.username}</td>
                    <td>${user.role === 'admin' ? 'مدير النظام' : 'مستخدم عادي'}</td>
                    <td>${user.mustChangePassword ? 'يجب تغيير كلمة المرور' : 'نشط'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteUser('${user.username}')">حذف</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // الحصول على اسم الشهر بالعربية
        function getMonthName(monthNumber) {
            const months = [
                "يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو",
                "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"
            ];
            return months[parseInt(monthNumber) - 1] || "غير معروف";
        }

        // الحصول على آخر قراءة للعميل
        function getLastReading(customerCode) {
            const customerInvoices = invoices
                .filter(inv => inv.customerCode === customerCode)
                .sort((a, b) => new Date(b.issueDate) - new Date(a.issueDate));
            
            if (customerInvoices.length > 0) {
                return customerInvoices[0].currentReading;
            }
            
            return 0;
        }

        // إضافة حركة صندوق
        function addCashBoxMovement(cashBoxId, description, debit, credit) {
            const cashBox = cashBoxes.find(cb => cb.id === cashBoxId);
            if (!cashBox) return;
            
            // تحديث رصيد الصندوق
            cashBox.balance = cashBox.balance - debit + credit;
            
            const movement = {
                id: 'MOV-' + Date.now(),
                cashBoxId: cashBoxId,
                date: new Date().toISOString().split('T')[0],
                description: description,
                debit: debit,
                credit: credit,
                balance: cashBox.balance
            };
            
            cashBoxMovements.push(movement);
            return movement;
        }

        // تحديث معاينة الفاتورة
        function updateInvoicePreview(consumption, rate, arrears, totalAmount) {
            const customerSelect = document.getElementById('customerSelect');
            const selectedOption = customerSelect.options[customerSelect.selectedIndex];
            const customerName = selectedOption.text.split(' (')[0];
            const customerCode = customerSelect.value;
            
            const customer = customers.find(c => c.code === customerCode);
            const month = document.getElementById('invoiceMonth').value;
            const year = new Date().getFullYear();
            
            document.getElementById('previewCustomerName').textContent = customerName;
            document.getElementById('previewCustomerCode').textContent = customerCode;
            document.getElementById('previewCustomerAddress').textContent = customer ? customer.address : '-';
            document.getElementById('previewPreviousReading').textContent = document.getElementById('previousReading').value;
            document.getElementById('previewCurrentReading').textContent = document.getElementById('currentReading').value;
            document.getElementById('previewConsumption').textContent = consumption;
            document.getElementById('previewRate').textContent = rate + ' ريال يمني/ك.و.س';
            document.getElementById('previewArrears').textContent = arrears + ' ريال يمني';
            document.getElementById('previewTotal').textContent = totalAmount.toFixed(2) + ' ريال يمني';
            
            // تاريخ اليوم
            const today = new Date();
            document.getElementById('previewIssueDate').textContent = today.toLocaleDateString('ar-SA');
            
            // الشهر المستحق
            if (month) {
                document.getElementById('previewMonth').textContent = getMonthName(month) + ' ' + year;
                
                // موعد السداد (بعد عدد أيام السماح من تاريخ الإصدار)
                const dueDate = new Date(today);
                dueDate.setDate(today.getDate() + settings.dueDays);
                document.getElementById('previewDueDate').textContent = dueDate.toLocaleDateString('ar-SA');
            }
            
            // رقم الفاتورة التالي
            document.getElementById('previewInvoiceNo').textContent = 'INV-' + year + '-' + String(invoices.length + 1).padStart(4, '0');
        }

        // طباعة الفاتورة
        function printInvoice() {
            const invoicePreview = document.getElementById('invoicePreview');
            invoicePreview.style.display = 'block';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>فاتورة كهرباء</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 15mm; }
                        .invoice-header { display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #2c3e50; }
                        .invoice-details { margin-bottom: 20px; }
                        .invoice-table { margin-bottom: 20px; width: 100%; }
                        .invoice-table table { width: 100%; border: 1px solid #ddd; border-collapse: collapse; }
                        .invoice-table th, .invoice-table td { border: 1px solid #ddd; padding: 10px; text-align: right; }
                        .invoice-footer { margin-top: 30px; text-align: center; color: #777; font-size: 0.9rem; }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${invoicePreview.innerHTML}
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="window.print()">طباعة</button>
                        <button onclick="window.close()">إغلاق</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            
            invoicePreview.style.display = 'none';
        }

        // طباعة إشعار التسديد
        function printReceipt() {
            const paymentCustomerSelect = document.getElementById('paymentCustomerSelect');
            const selectedOption = paymentCustomerSelect.options[paymentCustomerSelect.selectedIndex];
            const customerName = selectedOption.text.split(' (')[0];
            const customerCode = paymentCustomerSelect.value;
            const paymentAmount = document.getElementById('paymentAmount').value;
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentMethod = document.getElementById('paymentMethod').options[document.getElementById('paymentMethod').selectedIndex].text;
            const cashBox = getCurrentUserCashBox();
            const cashBoxName = cashBox ? cashBox.name : 'غير معروف';
            const paymentNotes = document.getElementById('paymentNotes').value;
            
            if (!customerName || !paymentAmount) {
                alert('يرجى ملء بيانات الدفع أولاً');
                return;
            }
            
            // تحديث معاينة الإشعار
            document.getElementById('previewReceiptCustomerName').textContent = customerName;
            document.getElementById('previewReceiptCustomerCode').textContent = customerCode;
            document.getElementById('previewReceiptDate').textContent = new Date(paymentDate).toLocaleDateString('ar-SA');
            document.getElementById('previewPaymentMethod').textContent = paymentMethod;
            document.getElementById('previewPaymentAmount').textContent = paymentAmount + ' ريال يمني';
            document.getElementById('previewCashBoxName').textContent = cashBoxName;
            document.getElementById('previewPaymentNumber').textContent = lastGeneratedPayment ? lastGeneratedPayment.number : 'PAY-' + new Date().getFullYear() + '-' + Math.floor(1000 + Math.random() * 9000);
            document.getElementById('previewPaymentNotes').textContent = paymentNotes || 'لا يوجد';
            document.getElementById('previewTotalAmount').textContent = paymentAmount;
            document.getElementById('previewReceiptNo').textContent = lastGeneratedPayment ? lastGeneratedPayment.number : 'RC-' + new Date().getFullYear() + '-' + Math.floor(1000 + Math.random() * 9000);
            
            // عرض معاينة الإشعار
            document.getElementById('receiptPreview').style.display = 'block';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>إشعار تسديد</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 15mm; }
                        .invoice-header { display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #2c3e50; }
                        .invoice-details { margin-bottom: 20px; }
                        .invoice-table { margin-bottom: 20px; width: 100%; }
                        .invoice-table table { width: 100%; border: 1px solid #ddd; border-collapse: collapse; }
                        .invoice-table th, .invoice-table td { border: 1px solid #ddd; padding: 10px; text-align: right; }
                        .invoice-table th { background: #f5f5f5; font-weight: bold; }
                        .invoice-footer { margin-top: 30px; text-align: center; color: #777; font-size: 0.9rem; }
                        .invoice-total { text-align: left; margin-top: 20px; font-size: 1.2rem; font-weight: bold; }
                        @media print {
                            body { margin: 0; }
                            button { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${document.getElementById('receiptPreview').innerHTML}
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="window.print()">طباعة</button>
                        <button onclick="window.close()">إغلاق</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            
            document.getElementById('receiptPreview').style.display = 'none';
        }

        // إضافة عميل جديد
        document.getElementById('customerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // التحقق من صحة رقم الهاتف
            const phone = document.getElementById('customerPhone').value;
            if (!/^7\d{8}$/.test(phone)) {
                alert('رقم الهاتف غير صحيح! يجب أن يتكون من 9 أرقام ويبدأ بـ 7');
                return;
            }
            
            // إنشاء كود عميل مكون من 3 أرقام
            let customerCode = '';
            if (customers.length === 0) {
                customerCode = '001';
            } else {
                // البحث عن أكبر كود موجود
                const maxCode = Math.max(...customers.map(c => parseInt(c.code)));
                customerCode = String(maxCode + 1).padStart(3, '0');
                // إذا تجاوز 999، نبحث عن فجوة
                if (maxCode >= 999) {
                    // نبحث عن أول فجوة في الأرقام
                    for (let i = 1; i <= 999; i++) {
                        const code = String(i).padStart(3, '0');
                        if (!customers.find(c => c.code === code)) {
                            customerCode = code;
                            break;
                        }
                    }
                }
            }
            
            const newCustomer = {
                code: customerCode,
                name: document.getElementById('customerName').value,
                city: document.getElementById('customerCity').value,
                phone: phone,
                address: document.getElementById('customerAddress').value,
                registrationDate: document.getElementById('registrationDate').value
            };
            
            customers.push(newCustomer);
            saveData();
            
            alert('تم إضافة العميل بنجاح!');
            this.reset();
            document.getElementById('registrationDate').valueAsDate = new Date();
        });

        // إضافة فاتورة جديدة
        document.getElementById('readingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customerCode = document.getElementById('customerSelect').value;
            const month = document.getElementById('invoiceMonth').value;
            const year = new Date().getFullYear();
            const invoiceNumber = 'INV-' + year + '-' + String(invoices.length + 1).padStart(4, '0');
            
            const newInvoice = {
                number: invoiceNumber,
                customerCode: customerCode,
                month: month,
                year: year,
                previousReading: parseFloat(document.getElementById('previousReading').value),
                currentReading: parseFloat(document.getElementById('currentReading').value),
                consumption: parseFloat(document.getElementById('consumption').value),
                rate: parseFloat(document.getElementById('rate').value),
                arrears: parseFloat(document.getElementById('arrears').value),
                totalAmount: parseFloat(document.getElementById('totalAmount').value),
                issueDate: new Date().toISOString().split('T')[0],
                paid: false
            };
            
            invoices.push(newInvoice);
            lastGeneratedInvoice = newInvoice;
            
            // تحديث معاينة الفاتورة
            updateInvoicePreview(
                newInvoice.consumption,
                newInvoice.rate,
                newInvoice.arrears,
                newInvoice.totalAmount
            );
            
            saveData();
            
            alert('تم ترحيل الفاتورة بنجاح! يمكنك الآن طباعتها.');
            document.getElementById('printInvoiceBtn').style.display = 'inline-block';
            this.reset();
            document.getElementById('invoiceMonth').selectedIndex = 0;
        });

        // إضافة دفعة جديدة
        document.getElementById('paymentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customerCode = document.getElementById('paymentCustomerSelect').value;
            const cashBoxId = document.getElementById('cashBoxId').value;
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            
            if (!cashBoxId) {
                alert('لا يوجد صندوق مرتبط بحسابك! الرجاء التواصل مع المدير');
                return;
            }
            
            const paymentNumber = 'PAY-' + new Date().getFullYear() + '-' + String(payments.length + 1).padStart(4, '0');
            
            const newPayment = {
                number: paymentNumber,
                customerCode: customerCode,
                amount: paymentAmount,
                date: document.getElementById('paymentDate').value,
                method: document.getElementById('paymentMethod').value,
                cashBoxId: cashBoxId,
                notes: document.getElementById('paymentNotes').value
            };
            
            // إضافة حركة الصندوق (دائن)
            addCashBoxMovement(cashBoxId, `سداد فاتورة - ${newPayment.notes || ''}`, 0, paymentAmount);
            
            payments.push(newPayment);
            lastGeneratedPayment = newPayment;
            
            saveData();
            
            alert('تم تسجيل الدفع بنجاح! يمكنك الآن طباعة إشعار التسديد.');
            document.getElementById('printReceiptBtn').style.display = 'inline-block';
            this.reset();
            document.getElementById('paymentDate').valueAsDate = new Date();
            updateCashBoxDisplay();
        });

        // إضافة صندوق جديد
        document.getElementById('cashBoxForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const cashBoxId = 'CB-' + Date.now();
            const initialBalance = parseFloat(document.getElementById('initialBalance').value);
            
            const newCashBox = {
                id: cashBoxId,
                name: document.getElementById('cashBoxName').value,
                userId: document.getElementById('cashBoxUser').value,
                balance: initialBalance,
                status: document.getElementById('cashBoxStatus').value,
                created: new Date().toISOString()
            };
            
            cashBoxes.push(newCashBox);
            
            // إضافة حركة الافتتاح إذا كان الرصيد الافتتاحي أكبر من صفر
            if (initialBalance > 0) {
                addCashBoxMovement(cashBoxId, 'رصيد افتتاحي', 0, initialBalance);
            }
            
            saveData();
            
            alert('تم إضافة الصندوق بنجاح!');
            this.reset();
        });

        // إضافة مستخدم جديد
        document.getElementById('userForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('userUsername').value;
            const password = document.getElementById('userInitialPassword').value;
            
            // التحقق من عدم وجود مستخدم بنفس الاسم
            if (users.find(u => u.username === username)) {
                alert('اسم المستخدم موجود مسبقاً!');
                return;
            }
            
            const newUser = {
                username: username,
                password: password,
                fullName: document.getElementById('userFullName').value,
                role: document.getElementById('userRole').value,
                created: new Date().toISOString(),
                mustChangePassword: true, // إضافة خاصية لتغيير كلمة المرور
                isFirstLogin: true
            };
            
            users.push(newUser);
            saveData();
            
            alert('تم إضافة المستخدم بنجاح! سيتم طلب تغيير كلمة المرور عند أول دخول.');
            this.reset();
        });

        // حفظ الإعدادات
        document.getElementById('settingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            settings.electricityRate = parseFloat(document.getElementById('electricityRate').value);
            settings.dueDays = parseInt(document.getElementById('dueDays').value);
            
            saveData();
            alert('تم حفظ الإعدادات بنجاح!');
        });

        // معالجة تغيير كلمة المرور من التبويب
        document.getElementById('changePasswordTabForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPasswordTab').value;
            const newPassword = document.getElementById('newPasswordTab').value;
            const confirmPassword = document.getElementById('confirmPasswordTab').value;
            
            // التحقق من كلمة المرور الحالية
            if (currentPassword !== currentUser.password) {
                alert('كلمة المرور الحالية غير صحيحة!');
                return;
            }
            
            // التحقق من تطابق كلمة المرور الجديدة
            if (newPassword !== confirmPassword) {
                alert('كلمة المرور الجديدة غير متطابقة!');
                return;
            }
            
            // تحديث كلمة المرور
            currentUser.password = newPassword;
            currentUser.mustChangePassword = false;
            currentUser.isFirstLogin = false;
            
            saveData();
            alert('تم تغيير كلمة المرور بنجاح!');
            this.reset();
        });

        // معالجة تغيير كلمة المرور من النافذة المنبثقة
        document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // التحقق من كلمة المرور الحالية
            if (currentPassword !== currentUser.password) {
                alert('كلمة المرور الحالية غير صحيحة!');
                return;
            }
            
            // التحقق من تطابق كلمة المرور الجديدة
            if (newPassword !== confirmPassword) {
                alert('كلمة المرور الجديدة غير متطابقة!');
                return;
            }
            
            // تحديث كلمة المرور
            currentUser.password = newPassword;
            currentUser.mustChangePassword = false;
            currentUser.isFirstLogin = false;
            
            saveData();
            hideChangePasswordModal();
            alert('تم تغيير كلمة المرور بنجاح!');
            this.reset();
        });

        // حساب الفاتورة
        document.getElementById('calculateBtn').addEventListener('click', function() {
            const previousReading = parseFloat(document.getElementById('previousReading').value) || 0;
            const currentReading = parseFloat(document.getElementById('currentReading').value) || 0;
            const rate = parseFloat(document.getElementById('rate').value) || 0;
            const arrears = parseFloat(document.getElementById('arrears').value) || 0;
            
            if (currentReading < previousReading) {
                alert('القراءة الحالية يجب أن تكون أكبر من أو تساوي القراءة السابقة');
                return;
            }
            
            const consumption = currentReading - previousReading;
            const consumptionAmount = consumption * rate;
            const totalAmount = consumptionAmount + arrears;
            
            document.getElementById('consumption').value = consumption;
            document.getElementById('totalAmount').value = totalAmount.toFixed(2);
            
            // تحديث معاينة الفاتورة
            updateInvoicePreview(consumption, rate, arrears, totalAmount);
        });

        // توليد كشف إجمالي في شكل جدول
        function generateSummaryStatement(customer, invoices, payments, fromDate, toDate, type) {
            let totalInvoices = 0;
            let totalPayments = 0;
            
            invoices.forEach(invoice => {
                totalInvoices += parseFloat(invoice.totalAmount);
            });
            
            payments.forEach(payment => {
                totalPayments += parseFloat(payment.amount);
            });
            
            const balance = totalInvoices - totalPayments;
            const isDebit = balance > 0;
            
            return `
                <h3>كشف حساب إجمالي ${type === 'عميل' ? 'للعميل' : 'للصندوق'}: ${customer.name}</h3>
                <p>الفترة من ${fromDate} إلى ${toDate}</p>
                
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th colspan="2">ملخص الحساب</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>إجمالي الفواتير</strong></td>
                            <td class="summary-negative">${totalInvoices.toFixed(2)} ريال يمني</td>
                        </tr>
                        <tr>
                            <td><strong>إجمالي المدفوعات</strong></td>
                            <td class="summary-positive">${totalPayments.toFixed(2)} ريال يمني</td>
                        </tr>
                        <tr class="summary-total">
                            <td><strong>${isDebit ? 'الرصيد عليكم' : 'الرصيد لكم'}</strong></td>
                            <td class="${isDebit ? 'summary-negative' : 'summary-positive'}">
                                ${Math.abs(balance).toFixed(2)} ريال يمني
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th colspan="3">تفاصيل الحركات</th>
                        </tr>
                        <tr>
                            <th>نوع الحركة</th>
                            <th>عدد الحركات</th>
                            <th>الإجمالي (ريال يمني)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>الفواتير</td>
                            <td>${invoices.length}</td>
                            <td class="summary-negative">${totalInvoices.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>المدفوعات</td>
                            <td>${payments.length}</td>
                            <td class="summary-positive">${totalPayments.toFixed(2)}</td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        // توليد كشف إجمالي للصناديق في شكل جدول
        function generateCashBoxSummary(cashBox, movements, fromDate, toDate) {
            let totalDebit = 0;
            let totalCredit = 0;
            
            movements.forEach(movement => {
                totalDebit += parseFloat(movement.debit);
                totalCredit += parseFloat(movement.credit);
            });
            
            const netFlow = totalCredit - totalDebit;
            const debitMovements = movements.filter(m => m.debit > 0).length;
            const creditMovements = movements.filter(m => m.credit > 0).length;
            
            return `
                <h3>كشف إجمالي للصندوق: ${cashBox.name}</h3>
                <p>الفترة من ${fromDate} إلى ${toDate}</p>
                
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th colspan="2">ملخص الصندوق</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>إجمالي المدفوعات (مدين)</strong></td>
                            <td class="summary-negative">${totalDebit.toFixed(2)} ريال يمني</td>
                        </tr>
                        <tr>
                            <td><strong>إجمالي المتحصلات (دائن)</strong></td>
                            <td class="summary-positive">${totalCredit.toFixed(2)} ريال يمني</td>
                        </tr>
                        <tr class="summary-total">
                            <td><strong>${netFlow >= 0 ? 'صافي التدفق الداخل' : 'صافي التدفق الخارج'}</strong></td>
                            <td class="${netFlow >= 0 ? 'summary-positive' : 'summary-negative'}">
                                ${Math.abs(netFlow).toFixed(2)} ريال يمني
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th colspan="3">تفاصيل حركات الصندوق</th>
                        </tr>
                        <tr>
                            <th>نوع الحركة</th>
                            <th>عدد الحركات</th>
                            <th>الإجمالي (ريال يمني)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>المدفوعات (مدين)</td>
                            <td>${debitMovements}</td>
                            <td class="summary-negative">${totalDebit.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>المتحصلات (دائن)</td>
                            <td>${creditMovements}</td>
                            <td class="summary-positive">${totalCredit.toFixed(2)}</td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        // توليد كشف حساب محاسبي تفصيلي للعملاء
        function generateAccountingStatement(customer, invoices, payments, fromDate, toDate, type) {
            // دمج الفواتير والمدفوعات في قائمة واحدة
            let transactions = [];
            
            // إضافة الفواتير كمديونيات (مدين)
            invoices.forEach(invoice => {
                transactions.push({
                    date: invoice.issueDate,
                    description: `فاتورة كهرباء - ${getMonthName(invoice.month)} ${invoice.year}`,
                    debit: parseFloat(invoice.totalAmount),
                    credit: 0,
                    type: 'invoice'
                });
            });
            
            // إضافة المدفوعات كائتمانات (دائن)
            payments.forEach(payment => {
                transactions.push({
                    date: payment.date,
                    description: `سداد فاتورة - ${payment.notes || ''}`,
                    debit: 0,
                    credit: parseFloat(payment.amount),
                    type: 'payment'
                });
            });
            
            // ترتيب المعاملات حسب التاريخ
            transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // حساب الرصيد المتداول
            let balance = 0;
            let totalDebit = 0;
            let totalCredit = 0;
            
            transactions.forEach(transaction => {
                totalDebit += transaction.debit;
                totalCredit += transaction.credit;
                balance += transaction.debit - transaction.credit;
                transaction.balance = balance;
            });
            
            // تحديد الاتجاه النهائي
            const isDebit = balance > 0;
            const balanceText = isDebit ? 
                `الرصيد عليكم: ${Math.abs(balance).toFixed(2)} ريال يمني` : 
                `الرصيد لكم: ${Math.abs(balance).toFixed(2)} ريال يمني`;
            
            let html = `
                <h3>كشف حساب محاسبي ${type === 'عميل' ? 'للعميل' : 'للصندوق'}: ${customer.name}</h3>
                <p>الفترة من ${fromDate} إلى ${toDate}</p>
                <table class="accounting-table">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>البيان</th>
                            <th>مدين (ريال يمني)</th>
                            <th>دائن (ريال يمني)</th>
                            <th>الرصيد (ريال يمني)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            transactions.forEach(transaction => {
                const balanceClass = transaction.balance >= 0 ? 'balance-positive' : 'balance-negative';
                html += `
                    <tr>
                        <td>${transaction.date}</td>
                        <td>${transaction.description}</td>
                        <td class="debit">${transaction.debit > 0 ? transaction.debit.toFixed(2) : '-'}</td>
                        <td class="credit">${transaction.credit > 0 ? transaction.credit.toFixed(2) : '-'}</td>
                        <td class="${balanceClass}">${transaction.balance.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            // إضافة صف الإجماليات
            html += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2"><strong>الإجمالي</strong></td>
                            <td class="debit"><strong>${totalDebit.toFixed(2)}</strong></td>
                            <td class="credit"><strong>${totalCredit.toFixed(2)}</strong></td>
                            <td><strong>${balance.toFixed(2)}</strong></td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>${balanceText}</strong></td>
                            <td class="${isDebit ? 'debit' : 'credit'}"><strong>${Math.abs(balance).toFixed(2)}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            `;
            
            return html;
        }

        // توليد كشف حساب للصناديق
        function generateCashBoxStatement(cashBox, movements, fromDate, toDate) {
            // ترتيب الحركات حسب التاريخ
            movements.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let html = `
                <h3>كشف حساب الصندوق: ${cashBox.name}</h3>
                <p>الفترة من ${fromDate} إلى ${toDate}</p>
                <table class="accounting-table">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>البيان</th>
                            <th>مدين (ريال يمني)</th>
                            <th>دائن (ريال يمني)</th>
                            <th>الرصيد (ريال يمني)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            movements.forEach(movement => {
                html += `
                    <tr>
                        <td>${movement.date}</td>
                        <td>${movement.description}</td>
                        <td class="debit">${movement.debit > 0 ? movement.debit.toFixed(2) : '-'}</td>
                        <td class="credit">${movement.credit > 0 ? movement.credit.toFixed(2) : '-'}</td>
                        <td>${movement.balance.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            return html;
        }

        // كشف حساب العميل
        document.getElementById('statementForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const accountValue = document.getElementById('statementAccountSelect').value;
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const detailType = document.getElementById('statementDetailType').value;
            
            if (!accountValue) {
                alert('الرجاء اختيار حساب صحيح!');
                return;
            }
            
            const [type, id] = accountValue.split('_');
            
            // عرض النتائج
            const statementContent = document.getElementById('statementContent');
            let html = '';
            
            if (type === 'customer') {
                const customer = customers.find(c => c.code === id);
                if (!customer) {
                    alert('الرجاء اختيار عميل صحيح!');
                    return;
                }
                
                // فلترة الفواتير والمدفوعات حسب العميل والفترة
                const customerInvoices = invoices.filter(inv => 
                    inv.customerCode === id && 
                    inv.issueDate >= fromDate && 
                    inv.issueDate <= toDate
                );
                
                const customerPayments = payments.filter(pay => 
                    pay.customerCode === id && 
                    pay.date >= fromDate && 
                    pay.date <= toDate
                );
                
                if (detailType === 'detailed') {
                    html = generateAccountingStatement(customer, customerInvoices, customerPayments, fromDate, toDate, 'عميل');
                } else {
                    html = generateSummaryStatement(customer, customerInvoices, customerPayments, fromDate, toDate, 'عميل');
                }
            } else if (type === 'cashbox') {
                const cashBox = cashBoxes.find(cb => cb.id === id);
                if (!cashBox) {
                    alert('الرجاء اختيار صندوق صحيح!');
                    return;
                }
                
                // فلترة حركات الصندوق حسب الفترة
                const cashBoxMovementsFiltered = cashBoxMovements.filter(mov => 
                    mov.cashBoxId === id && 
                    mov.date >= fromDate && 
                    mov.date <= toDate
                );
                
                if (detailType === 'detailed') {
                    html = generateCashBoxStatement(cashBox, cashBoxMovementsFiltered, fromDate, toDate);
                } else {
                    html = generateCashBoxSummary(cashBox, cashBoxMovementsFiltered, fromDate, toDate);
                }
            }
            
            statementContent.innerHTML = html;
            document.getElementById('statementResult').style.display = 'block';
        });

        // وظائف الحذف
        function deleteCustomer(code) {
            if (confirm('هل أنت متأكد من حذف هذا العميل؟')) {
                customers = customers.filter(c => c.code !== code);
                saveData();
            }
        }

        function deleteCashBox(id) {
            if (confirm('هل أنت متأكد من حذف هذا الصندوق؟')) {
                cashBoxes = cashBoxes.filter(cb => cb.id !== id);
                saveData();
            }
        }

        function deleteUser(username) {
            if (username === currentUser.username) {
                alert('لا يمكن حذف المستخدم الحالي!');
                return;
            }
            
            if (confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
                users = users.filter(u => u.username !== username);
                saveData();
            }
        }

        // أحداث التحميل
        window.addEventListener('DOMContentLoaded', async function() {
            updateConnectionStatus();
            
            // انتظار تهيئة Firebase
            await waitForFirebase();
            console.log('Firebase جاهز للاستخدام');
            
            // تحميل البيانات
            loadFromLocalStorage();
            if (isOnline) {
                const success = await loadFromFirebase();
                if (success) {
                    saveData();
                }
            } else {
                saveData();
            }

            // مستمعات الأحداث
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
            
            // زر المزامنة
            document.getElementById('syncButton').addEventListener('click', manualSync);

            // زر تصفير قاعدة البيانات
            document.getElementById('resetDataBtn').addEventListener('click', resetDatabase);

            // تسجيل الدخول
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                const result = await loginUser(username, password);
                
                if (result.success) {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    document.getElementById('loginError').classList.add('hidden');
                    updateCashBoxDisplay();
                    saveData();
                } else {
                    document.getElementById('loginError').classList.remove('hidden');
                }
            });

            // تسجيل الخروج
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('loginForm').reset();
                document.getElementById('loginError').classList.add('hidden');
                currentUser = null;
            });

            // تبديل التبويبات
            document.querySelectorAll('nav a, .sidebar a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    
                    // منع الوصول إلى تبويب الإعدادات للمستخدمين العاديين
                    if (tabId === 'settings' && (!currentUser || currentUser.role !== 'admin')) {
                        alert('ليس لديك صلاحية للوصول إلى الإعدادات العامة');
                        return;
                    }
                    
                    if (tabId) {
                        document.querySelectorAll('.tab-content').forEach(tab => {
                            tab.classList.remove('active');
                        });
                        document.querySelectorAll('nav a, .sidebar a').forEach(link => {
                            link.classList.remove('active');
                        });
                        
                        document.getElementById(tabId).classList.add('active');
                        this.classList.add('active');
                        
                        // تحديث عرض الصندوق عند التبديل إلى تبويب المدفوعات
                        if (tabId === 'payments') {
                            updateCashBoxDisplay();
                        }
                    }
                });
            });

            // عند تغيير العميل في تسجيل القراءات
            document.getElementById('customerSelect').addEventListener('change', function() {
                const customerCode = this.value;
                if (customerCode) {
                    const lastReading = getLastReading(customerCode);
                    document.getElementById('previousReading').value = lastReading;
                    
                    // حساب المتأخرات تلقائياً وتعيينها في الحقل
                    const arrears = calculateCustomerBalance(customerCode);
                    document.getElementById('arrears').value = arrears.toFixed(2);
                    
                    // إعادة حساب الفاتورة إذا كانت هناك قيم في الحقول الأخرى
                    const currentReading = document.getElementById('currentReading').value;
                    if (currentReading) {
                        document.getElementById('calculateBtn').click();
                    }
                } else {
                    document.getElementById('previousReading').value = '';
                    document.getElementById('arrears').value = '0';
                }
            });

            // زر طباعة الفاتورة
            document.getElementById('printInvoiceBtn').addEventListener('click', printInvoice);

            // زر طباعة إشعار التسديد
            document.getElementById('printReceiptBtn').addEventListener('click', printReceipt);

            // زر طباعة كشف الحساب
            document.getElementById('printStatementBtn').addEventListener('click', function() {
                const statementContent = document.getElementById('statementContent').innerHTML;
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html dir="rtl">
                    <head>
                        <title>كشف حساب</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                            th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: right; }
                            th { background: #f5f5f5; }
                            .debit { color: #e74c3c; font-weight: bold; }
                            .credit { color: #27ae60; font-weight: bold; }
                            .balance-positive { color: #27ae60; font-weight: bold; }
                            .balance-negative { color: #e74c3c; font-weight: bold; }
                            .summary-table { width: 100%; border-collapse: collapse; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                            .summary-table th { background: #2c3e50; color: white; padding: 15px; text-align: center; font-size: 1.1rem; }
                            .summary-table td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: center; }
                            .summary-table tr:nth-child(even) { background: #f8f9fa; }
                            .summary-total { background: #ecf0f1 !important; font-weight: bold; font-size: 1.1rem; }
                            .summary-positive { color: #27ae60; font-weight: bold; }
                            .summary-negative { color: #e74c3c; font-weight: bold; }
                            tfoot { font-weight: bold; }
                            tfoot td { background-color: #f9f9f9; }
                            @media print {
                                body { margin: 0; }
                                button { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        ${statementContent}
                        <div style="text-align: center; margin-top: 30px;">
                            <button onclick="window.print()">طباعة</button>
                            <button onclick="window.close()">إغلاق</button>
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            });

            // إغلاق نافذة تغيير كلمة المرور عند النقر خارجها
            document.getElementById('changePasswordModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideChangePasswordModal();
                }
            });

            // تعيين التاريخ الحالي كافتراضي في بعض الحقول
            document.getElementById('registrationDate').valueAsDate = new Date();
            document.getElementById('paymentDate').valueAsDate = new Date();
            document.getElementById('fromDate').valueAsDate = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            document.getElementById('toDate').valueAsDate = new Date();
        });

    </script>
</body>
</html>